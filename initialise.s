.syntax unified
.thumb

#include "definitions.s"



enable_peripheral_clocks:

	LDR R0, =RCC

	LDR R1, [R0, #AHBENR]
	ORR R1, 1 << GPIOE_ENABLE | 1 << GPIOD_ENABLE | 1 << GPIOC_ENABLE | 1 << GPIOB_ENABLE | 1 << GPIOA_ENABLE  @ enable GPIO
	STR R1, [R0, #AHBENR]

	BX LR

enable_usart1:

	LDR R0, =GPIOC

	LDR R1, =0x77
	STRB R1, [R0, AFRL + 2]

	LDR R1, [R0, GPIO_MODER]
	ORR R1, 0xA00
	STR R1, [R0, GPIO_MODER]

	LDR R1, [R0, GPIO_OSPEEDR]
	ORR R1, 0xF00
	STR R1, [R0, GPIO_OSPEEDR]

	LDR R0, =RCC
	LDR R1, [R0, #APB2ENR]
	ORR R1, 1 << USART1_EN
	STR R1, [R0, #APB2ENR]

	MOV R1, #0x46
	LDR R0, =USART1
	STRH R1, [R0, #USART_BRR]

	LDR R0, =USART1
	LDR R1, [R0, #USART_CR1]
	ORR R1, 1 << UART_TE | 1 << UART_RE | 1 << UART_UE

	STR R1, [R0, #USART_CR1]

	BX LR

enable_uart4:

	LDR R0, =GPIOC

	LDR R1, =0x55
	STRB R1, [R0, AFRH + 1]

	LDR R1, =0x00A00A00
	STR R1, [R0, GPIO_MODER]

	LDR R1, =0x00F00F00
	STR R1, [R0, GPIO_OSPEEDR]

	LDR R0, =RCC
	LDR R1, [R0, #APB1ENR]
	ORR R1, 1 << UART4_EN
	STR R1, [R0, #APB1ENR]

	MOV R1, #0x46
	LDR R0, =UART4
	STRH R1, [R0, #USART_BRR]

	LDR R0, =UART4
	LDR R1, [R0, #USART_CR1]
	ORR R1, 1 << UART_TE | 1 << UART_RE | 1 << UART_UE

	STR R1, [R0, #USART_CR1]

	BX LR

initialise_power:

	LDR R0, =RCC

	LDR R1, [R0, #APB1ENR]
	ORR R1, 1 << PWREN
	STR R1, [R0, #APB1ENR]

	LDR R1, [R0, #APB2ENR]
	ORR R1, 1 << SYSCFGEN
	STR R1, [R0, #APB2ENR]

	BX LR

initialise_discovery_board:
	LDR R0, =GPIOE
	LDR R1, =0x5555
	STRH R1, [R0, #MODER + 2]
	BX LR

enable_timer2_clock:

	LDR R0, =RCC
	LDR R1, [R0, APB1ENR]
	ORR R1, 1 << TIM2EN
	STR R1, [R0, APB1ENR]
	BX LR

